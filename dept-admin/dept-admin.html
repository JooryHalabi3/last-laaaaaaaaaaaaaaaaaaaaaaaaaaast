<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title data-ar="لوحة إدارة القسم" data-en="Department Admin Dashboard">Department Admin Dashboard</title>

  <!-- خطوط مطابقة للهوم -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap" rel="stylesheet">

  <!-- نفس ملف التنسيق -->
  <link rel="stylesheet" href="dept-admin.css">
  <style>
    /* لمسة بسيطة لتوسيط البطاقة الكبيرة */
    .dashboard { flex-wrap: wrap; }
    .card.full { flex-basis: 100%; }
    .kpi-wrap { margin: 12px 40px; display: grid; grid-template-columns: repeat(4,minmax(160px,1fr)); gap: 14px; }
    .kpi { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow:0 4px 10px rgba(0,0,0,.04); }
    .kpi .t{font-size:.92rem;color:#374151}
    .kpi .v{font-weight:800;font-size:1.35rem;color:#0f172a}
    .list-card{ background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px; box-shadow:0 4px 10px rgba(0,0,0,.04); margin:16px 40px 24px;}
    .comp-table{width:100%;border-collapse:collapse;font-size:.95rem}
    .comp-table th,.comp-table td{padding:10px 12px;border-bottom:1px solid #eee;text-align:center;white-space:nowrap}
    .comp-table thead th{background:#f8fafc;font-weight:600;position:sticky;top:0;z-index:1}
    .kpi-refresh{display:flex;align-items:center;justify-content:center;margin-top:10px}
    .refresh-btn{background:#3b82f6;color:white;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:6px;font-size:.9rem;transition:all .2s ease}
    .refresh-btn:hover{background:#2563eb;transform:scale(1.05)}
    .refresh-btn:disabled{opacity:0.7;cursor:not-allowed}
    .refresh-btn svg{width:14px;height:14px}
    .animate-spin{animation:spin 1s linear infinite}
    @keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-title" data-ar="عُــــــونَك — مدير القسم" data-en="AOUNAK — Department Admin">عُــــــونَك — مدير القسم</div>
      <img src="/icon/hospital-logo.png" alt="شعار" class="header-logo"/>
<!-- Banner hidden by default -->
<div id="impersonation-banner" style="display:none; position:fixed; top:10px; left:10px; z-index:9999;">
  <button id="end-impersonation-btn"
          style="padding:8px 12px; border:none; border-radius:6px; background:#dc2626; color:#fff; cursor:pointer;">
    🔙 الرجوع لحساب السوبر
  </button>
</div>

      <a href="/login/profile.html" class="profile-link">
        <img src="/icon/patient1.png" class="profile-icon-small" alt="الملف الشخصي">
        <span data-ar="الملف الشخصي" data-en="Profile">الملف الشخصي</span>
      </a>

      <button id="notifBtn" class="notif-btn" title="الإشعارات">
        <svg class="notif-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2c.7 0 1.25.56 1.25 1.25v.51A6.75 6.75 0 0 1 19 10.5v4.06l1.49 2.49c.3.5-.06 1.12-.64 1.12H4.15c-.58 0-.94-.62-.64-1.12L5 14.56V10.5A6.75 6.75 0 0 1 10.75 3.76v-.51C10.75 2.56 11.3 2 12 2zm0 20a2.75 2.75 0 0 1-2.62-2h5.24A2.75 2.75 0 0 1 12 22z"/>
        </svg>
        <span id="notifCount" class="notif-count" style="display:none;">0</span>
      </button>

      <button id="langToggle" class="lang-toggle-btn">
        <img src="/icon/lang.png" class="lang-icon" alt="اللغة"/>
        <span id="langText">العربية | English</span>
      </button>

      <button id="deptStatusBtn" class="dept-status-btn" onclick="showDepartmentStatus()" title="Department Status">
        <img src="/icon/info.png" class="status-icon" alt="Department Status"/>
        <span data-ar="حالة القسم" data-en="Dept Status">Dept Status</span>
      </button>
    </div>
  </header>

  <main>
    <!-- كروت مدير القسم فقط -->
    <section class="dashboard">
      <div class="card">
        <img src="/icon/chart.png" alt="">
        <h3 data-ar="لوحة القسم" data-en="Department Dashboard">لوحة القسم</h3>
        <p data-ar="نظرة شاملة على شكاوى وطلبات القسم" data-en="Overview of department complaints and requests">نظرة شاملة على شكاوى وطلبات القسم</p>
        <a href="/dept-admin/dept-dashboard.html" class="btn" data-ar="عرض التفاصيل" data-en="Open Dashboard">عرض التفاصيل</a>
      </div>

      <div class="card">
        <img src="/icon/group.png" alt="">
        <h3 data-ar="موظفي القسم" data-en="Department Employees">موظفي القسم</h3>
        <p data-ar="إدارة موظفي القسم وصلاحياتهم" data-en="Manage department employees and permissions">إدارة موظفي القسم وصلاحياتهم</p>
        <a href="/admin/department-management.html" class="btn" data-ar="إدارة الموظفين" data-en="Manage Employees">إدارة الموظفين</a>
      </div>

      <div class="card">
        <img src="/icon/list.png" alt="">
        <h3 data-ar="شكاوى القسم" data-en="Department Complaints">شكاوى القسم</h3>
        <p data-ar="عرض وإدارة شكاوى القسم" data-en="View and manage department complaints">عرض وإدارة شكاوى القسم</p>
        <a href="/general complaints/general-complaints.html" class="btn" data-ar="عرض الشكاوى" data-en="View Complaints">عرض الشكاوى</a>
      </div>

      <div class="card">
        <img src="/icon/assignment.png" alt="">
        <h3 data-ar="توزيع الشكاوى" data-en="Complaint Assignment">توزيع الشكاوى</h3>
        <p data-ar="توزيع الشكاوى على موظفي القسم" data-en="Assign complaints to department employees">توزيع الشكاوى على موظفي القسم</p>
        <a href="#" onclick="openComplaintAssignment()" class="btn" data-ar="توزيع الشكاوى" data-en="Assign Complaints">توزيع الشكاوى</a>
      </div>

      <div class="card">
        <img src="/icon/logs.png" alt="">
        <h3 data-ar="سجلات القسم" data-en="Department Logs">سجلات القسم</h3>
        <p data-ar="مراجعة نشاطات موظفي القسم" data-en="Review department employee activities">مراجعة نشاطات موظفي القسم</p>
        <a href="/admin/logs.html" class="btn" data-ar="عرض السجلات" data-en="View Logs">عرض السجلات</a>
      </div>

      <div class="card">
        <img src="/icon/permissions.png" alt="">
        <h3 data-ar="إدارة الصلاحيات" data-en="Permission Management">إدارة الصلاحيات</h3>
        <p data-ar="إدارة صلاحيات موظفي القسم" data-en="Manage department employee permissions">إدارة صلاحيات موظفي القسم</p>
        <a href="#" onclick="openDepartmentPermissions()" class="btn" data-ar="إدارة الصلاحيات" data-en="Manage Permissions">إدارة الصلاحيات</a>
      </div>
    </section>

    <!-- KPIs الخاصة بالقسم -->
    <section class="kpi-wrap" id="kpiWrap">
      <div class="kpi"><div class="t" data-ar="إجمالي شكاوى القسم" data-en="Total Department Complaints">إجمالي شكاوى القسم</div><div class="v" id="kpiTotal">—</div></div>
      <div class="kpi"><div class="t" data-ar="المفتوحة" data-en="Open">المفتوحة</div><div class="v" id="kpiOpen">—</div></div>
      <div class="kpi"><div class="t" data-ar="قيد المعالجة" data-en="In Progress">قيد المعالجة</div><div class="v" id="kpiWip">—</div></div>
      <div class="kpi"><div class="t" data-ar="المغلقة" data-en="Closed">المغلقة</div><div class="v" id="kpiClosed">—</div></div>
      <div class="kpi-refresh">
        <button onclick="refreshDashboardData()" class="refresh-btn" title="Refresh Dashboard Data" data-ar="تحديث البيانات" data-en="Refresh Data">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M23 4v6h-6M1 20v-6h6M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/>
          </svg>
        </button>
      </div>
    </section>

    <!-- آخر شكاوى القسم -->
    <section class="list-card">
      <div class="table-title" data-ar="آخر 10 شكاوى القسم" data-en="Latest 10 Department Complaints">آخر 10 شكاوى القسم</div>
      <table class="comp-table" id="complaintsTable">
        <thead>
          <tr>
            <th data-ar="رقم الشكوى" data-en="Complaint ID">رقم الشكوى</th>
            <th data-ar="الموظف المسؤول" data-en="Assigned Employee">الموظف المسؤول</th>
            <th data-ar="الحالة" data-en="Status">الحالة</th>
            <th data-ar="تاريخ التقديم" data-en="Submission Date">تاريخ التقديم</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <!-- Department Employees Modal -->
  <div id="employeesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-ar="موظفي القسم" data-en="Department Employees">Department Employees</h2>
        <span class="close" onclick="closeModal('employeesModal')">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Search and Filters Section -->
        <div class="search-filters-section">
          <div class="search-bar">
            <input type="text" id="employeeSearch" placeholder="Search by Full Name or Employee ID..." data-ar-placeholder="البحث بالاسم الكامل أو رقم الموظف..." data-en-placeholder="Search by Full Name or Employee ID...">
            <button onclick="searchEmployees()" data-ar="بحث" data-en="Search">Search</button>
            <button onclick="clearEmployeeFilters()" data-ar="مسح الفلاتر" data-en="Clear Filters">Clear Filters</button>
          </div>
          <div class="quick-filters">
            <select id="roleFilter" onchange="filterEmployees()">
              <option value="" data-ar="جميع الأدوار" data-en="All Roles">All Roles</option>
              <option value="EMPLOYEE" data-ar="موظف" data-en="Employee">Employee</option>
              <option value="ADMIN" data-ar="مدير قسم" data-en="Department Admin">Department Admin</option>
            </select>
            <select id="statusFilter" onchange="filterEmployees()">
              <option value="" data-ar="جميع الحالات" data-en="All Status">All Status</option>
              <option value="active" data-ar="نشط" data-en="Active">Active</option>
              <option value="inactive" data-ar="غير نشط" data-en="Inactive">Inactive</option>
            </select>
          </div>
        </div>

        <!-- Loading State -->
        <div id="employeesLoading" class="loading-overlay" style="display: none;">
          <div class="loading-spinner"></div>
        </div>

        <!-- Empty State -->
        <div id="employeesEmptyState" class="empty-state" style="display: none;">
          <p data-ar="لا يوجد موظفين في قسمك" data-en="No employees found in your department">No employees found in your department</p>
          <button onclick="clearEmployeeFilters()" data-ar="مسح الفلاتر" data-en="Clear Filters">Clear Filters</button>
        </div>

        <!-- Error State -->
        <div id="employeesErrorState" class="error-state" style="display: none;">
          <p data-ar="حدث خطأ في تحميل البيانات" data-en="Error loading data">Error loading data</p>
          <button onclick="loadDepartmentEmployees()" data-ar="إعادة المحاولة" data-en="Retry">Retry</button>
        </div>

        <!-- Employees Table -->
        <div class="employees-table-container">
          <table id="employeesTable" class="data-table">
            <thead>
              <tr>
                <th onclick="sortEmployees('EmployeeID')" class="sortable" data-ar="رقم الموظف" data-en="Employee ID">Employee ID <span class="sort-icon">↕</span></th>
                <th onclick="sortEmployees('FullName')" class="sortable" data-ar="الاسم الكامل" data-en="Full Name">Full Name <span class="sort-icon">↕</span></th>
                <th data-ar="البريد الإلكتروني" data-en="Email">Email</th>
                <th data-ar="القسم" data-en="Department">Department</th>
                <th data-ar="الدور" data-en="Role">Role</th>
                <th data-ar="الحالة" data-en="Status">Status</th>
                <th data-ar="الهاتف" data-en="Phone">Phone</th>
                <th data-ar="اسم المستخدم" data-en="Username">Username</th>
                <th data-ar="الإجراءات" data-en="Actions">Actions</th>
              </tr>
            </thead>
            <tbody id="employeesTableBody">
              <!-- Employees will be loaded here -->
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="pagination" id="employeesPagination" style="display: none;">
          <button onclick="previousPage()" data-ar="السابق" data-en="Previous">Previous</button>
          <span id="pageInfo" data-ar="الصفحة" data-en="Page">Page</span>
          <button onclick="nextPage()" data-ar="التالي" data-en="Next">Next</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Department Complaints Modal -->
  <div id="complaintsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-ar="شكاوى القسم" data-en="Department Complaints">Department Complaints</h2>
        <span class="close" onclick="closeModal('complaintsModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="search-bar">
          <input type="text" id="complaintSearch" placeholder="Search complaints..." data-ar-placeholder="البحث في الشكاوى..." data-en-placeholder="Search complaints...">
          <button onclick="searchComplaints()" data-ar="بحث" data-en="Search">Search</button>
        </div>
        <div class="complaints-table-container">
          <table id="departmentComplaintsTable" class="data-table">
            <thead>
              <tr>
                <th data-ar="رقم الشكوى" data-en="Complaint ID">Complaint ID</th>
                <th data-ar="الموظف المسؤول" data-en="Assigned Employee">Assigned Employee</th>
                <th data-ar="الحالة" data-en="Status">Status</th>
                <th data-ar="تاريخ التقديم" data-en="Submission Date">Submission Date</th>
                <th data-ar="الإجراءات" data-en="Actions">Actions</th>
              </tr>
            </thead>
            <tbody id="departmentComplaintsTableBody">
              <!-- Complaints will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Complaint Assignment Modal -->
  <div id="assignmentModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-ar="توزيع الشكاوى" data-en="Complaint Assignment">Complaint Assignment</h2>
        <span class="close" onclick="closeModal('assignmentModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="assignment-filters">
          <select id="complaintFilter" onchange="filterComplaintsForAssignment()">
            <option value="unassigned" data-ar="غير مخصصة" data-en="Unassigned">Unassigned</option>
            <option value="all" data-ar="جميع الشكاوى" data-en="All Complaints">All Complaints</option>
          </select>
        </div>
                 <div class="assignment-table-container">
           <table id="assignmentTable" class="data-table">
             <thead>
               <tr>
                 <th data-ar="رقم الشكوى" data-en="Complaint ID">Complaint ID</th>
                 <th data-ar="الموظف المسؤول" data-en="Assigned Employee">Assigned Employee</th>
                 <th data-ar="الحالة" data-en="Status">Status</th>
                 <th data-ar="تاريخ التقديم" data-en="Submission Date">Submission Date</th>
                 <th data-ar="الإجراءات" data-en="Actions">Actions</th>
               </tr>
             </thead>
             <tbody id="assignmentTableBody">
               <!-- Assignment data will be loaded here -->
             </tbody>
           </table>
         </div>
      </div>
    </div>
  </div>

  <!-- Department Logs Modal -->
  <div id="logsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-ar="سجلات القسم" data-en="Department Logs">Department Logs</h2>
        <span class="close" onclick="closeModal('logsModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="logs-filters">
          <select id="logType" onchange="filterDepartmentLogs()">
            <option value="all" data-ar="جميع السجلات" data-en="All Logs">All Logs</option>
            <option value="login" data-ar="تسجيل دخول" data-en="Login">Login</option>
            <option value="complaint" data-ar="شكاوى" data-en="Complaints">Complaints</option>
            <option value="assignment" data-ar="توزيع" data-en="Assignment">Assignment</option>
          </select>
        </div>
        <div class="logs-table-container">
          <table id="departmentLogsTable" class="data-table">
            <thead>
              <tr>
                <th data-ar="الوقت" data-en="Time">Time</th>
                <th data-ar="الموظف" data-en="Employee">Employee</th>
                <th data-ar="النوع" data-en="Type">Type</th>
                <th data-ar="الوصف" data-en="Description">Description</th>
              </tr>
            </thead>
            <tbody id="departmentLogsTableBody">
              <!-- Logs will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Department Permissions Modal -->
  <div id="permissionsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 data-ar="إدارة صلاحيات القسم" data-en="Department Permission Management">Department Permission Management</h2>
        <span class="close" onclick="closeModal('permissionsModal')">&times;</span>
      </div>
      <div class="modal-body">
        <div class="search-bar">
          <input type="text" id="permissionSearch" placeholder="Search by name or employee number..." data-ar-placeholder="البحث بالاسم أو رقم الموظف..." data-en-placeholder="Search by name or employee number...">
          <button onclick="searchEmployeesForPermissions()" data-ar="بحث" data-en="Search">Search</button>
        </div>
        <div class="permissions-table-container">
          <table id="permissionsTable" class="data-table">
            <thead>
              <tr>
                <th data-ar="الاسم" data-en="Name">Name</th>
                <th data-ar="رقم الموظف" data-en="Employee Number">Employee Number</th>
                <th data-ar="الدور الحالي" data-en="Current Role">Current Role</th>
                <th data-ar="الصلاحيات" data-en="Permissions">Permissions</th>
                <th data-ar="الإجراءات" data-en="Actions">Actions</th>
              </tr>
            </thead>
            <tbody id="permissionsTableBody">
              <!-- Permissions data will be loaded here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
     </div>

   <!-- Individual Assignment Modal -->
   <div id="individualAssignmentModal" class="modal">
     <div class="modal-content">
       <div class="modal-header">
         <h2 data-ar="توزيع الشكوى" data-en="Assign Complaint">Assign Complaint</h2>
         <span class="close" onclick="closeIndividualAssignmentModal()">&times;</span>
       </div>
       <div class="modal-body">
         <!-- Loading State -->
         <div id="assignmentLoading" class="loading-overlay" style="display: none;">
           <div class="loading-spinner"></div>
           <p data-ar="جاري تحميل الموظفين..." data-en="Loading employees...">Loading employees...</p>
         </div>
         
         <div class="form-group">
           <label for="employeeSelect" data-ar="اختر موظف:" data-en="Select Employee:">Select Employee:</label>
           <select id="employeeSelect" class="form-control">
             <option value="">اختر موظف...</option>
           </select>
         </div>
         <div class="modal-actions">
           <button onclick="closeIndividualAssignmentModal()" class="btn-cancel" data-ar="إلغاء" data-en="Cancel">Cancel</button>
           <button onclick="confirmAssignment()" class="btn-confirm" data-ar="تأكيد التوزيع" data-en="Confirm Assignment">Confirm Assignment</button>
         </div>
       </div>
     </div>
   </div>

   <!-- Edit Permissions Modal -->
   <div id="editPermissionsModal" class="modal">
     <div class="modal-content">
       <div class="modal-header">
         <h2 data-ar="تعديل صلاحيات الموظف" data-en="Edit Employee Permissions">Edit Employee Permissions</h2>
         <span class="close" onclick="closeEditPermissionsModal()">&times;</span>
       </div>
       <div class="modal-body">
         <!-- Loading State -->
         <div id="permissionsLoading" class="loading-overlay" style="display: none;">
           <div class="loading-spinner"></div>
           <p data-ar="جاري تحميل الصلاحيات..." data-en="Loading permissions...">Loading permissions...</p>
         </div>
         
         <!-- Employee Info -->
         <div class="employee-info-section">
           <h3 id="employeeName" data-ar="اسم الموظف" data-en="Employee Name">Employee Name</h3>
           <p id="employeeDetails" data-ar="تفاصيل الموظف" data-en="Employee Details">Employee Details</p>
         </div>
         
         <!-- Permissions Section -->
         <div class="permissions-section">
           <h4 data-ar="الصلاحيات المتاحة" data-en="Available Permissions">Available Permissions</h4>
           <div class="permissions-grid" id="permissionsGrid">
             <!-- Permissions checkboxes will be loaded here -->
           </div>
         </div>
         
         <div class="modal-actions">
           <button onclick="closeEditPermissionsModal()" class="btn-cancel" data-ar="إلغاء" data-en="Cancel">Cancel</button>
           <button onclick="saveEmployeePermissions()" class="btn-confirm" data-ar="حفظ الصلاحيات" data-en="Save Permissions">Save Permissions</button>
         </div>
       </div>
     </div>
   </div>

      <script src="./dept-admin.js"></script>
   <script>
   (function () {
     // استخدمي نفس التخزين عندك: localStorage.user يحتوي RoleID
     function redirectByRole() {
       const user = JSON.parse(localStorage.getItem('user') || 'null');

       const roleId = Number(user.RoleID || user.roleId);
       if (roleId === 1) return '/superadmin/superadmin-home.html'; // سوبر أدمن
       if (roleId === 2) return '/employee/employee-home.html';   // موظف
       if (roleId === 3) return '/dept-admin/dept-admin.html';     // أدمن
     }

     // كل روابط "الصفحة الرئيسية" الموجودة في الشريط الجانبي
     const homeLinks = document.querySelectorAll(
       'aside .sidebar-menu a.menu-link[href$="/login/home.html"], aside .sidebar-menu a.menu-link[data-en="Home Page"], aside .sidebar-menu a.menu-link[data-ar="الصفحة الرئيسية"]'
     );

     homeLinks.forEach(a => {
       // خَلّي النقر يوجّه حسب الدور
       a.addEventListener('click', (e) => {
         e.preventDefault();
         window.location.href = redirectByRole();
       });

       // (اختياري) عدّلي الـ href الظاهر للـ Hover/Copy
       a.setAttribute('href', redirectByRole());
     });
   })();
   </script>
</body>
</html>
